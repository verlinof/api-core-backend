name: CI Docker

on:
  push:
    branches:
      - dev

env:
  SERVICES: "payment-service"

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: dev

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Setup SSH
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.SSH_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        PORT=${{ secrets.SSH_PORT }}
        HOST=${{ secrets.SSH_HOST }}
        echo "Open ${{ secrets }}..."
        echo "Open ${{ secrets.GITHUB_TOKEN }}..."        
        
        ssh-keyscan -p "${PORT:-22}" "$HOST" >> ~/.ssh/known_hosts

    - name: Build Docker Images and Save as TAR
      run: |
        mkdir -p images
        for SERVICE in $SERVICES; do
          IMAGE_NAME=$SERVICE:latest
          echo "üõ†Ô∏è Building $IMAGE_NAME"
            docker build -t $IMAGE_NAME ./services/$SERVICE
          docker save -o ./images/$SERVICE.tar $IMAGE_NAME
        done

    - name: Copy Images to VPS
      run: |
        for SERVICE in $SERVICES; do
          scp -P ${{ secrets.SSH_PORT }} ./images/$SERVICE.tar ${{ secrets.VPS_USER }}@${{ secrets.SSH_HOST }}:/tmp/
        done

    - name: Deploy Images on VPS
      run: |
        ssh -p ${{ secrets.SSH_PORT }} ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << EOF
          set -e
          for SERVICE in $SERVICES; do
            echo "üì¶ Loading image for \$SERVICE..."
            docker load -i /tmp/\$SERVICE.tar
            docker stop \$SERVICE || true
            docker rm \$SERVICE || true
            docker run -d --name \$SERVICE -p 8080:80 \$SERVICE:latest  # Ganti port sesuai kebutuhan
          done
        EOF
