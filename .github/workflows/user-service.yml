name: CI Docker

on:
  push:
    tags:
      - dev/user-service

env:
  SERVICES: "user-service"

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: dev

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Setup SSH
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.SSH_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        PORT=${{ secrets.SSH_PORT }}
        HOST=${{ secrets.SSH_HOST }}
        ssh-keyscan -p "${PORT:-22}" "$HOST" >> ~/.ssh/known_hosts
        cat ~/user-service/.env

    - name: Load Env
      run: |
        ENV_CONTENT=$(ssh -p ${{ secrets.SSH_PORT }} ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} 'cat /root/user-service/.env')
        echo "ENV_CONTENT<<EOF" >> $GITHUB_OUTPUT
        echo "$ENV_CONTENT" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT

    - name: Build Docker Images and Save as TAR
      run: |
        mkdir -p images
        echo "${{ steps.load_env.outputs.ENV_CONTENT }}" > ./services/user-service/.env

        IMAGE_NAME=user-service:latest
        echo "üõ†Ô∏è Building $IMAGE_NAME"
        docker build -t $IMAGE_NAME ./services/user-service
        docker save -o ./images/user-service.tar $IMAGE_NAME

    - name: Copy Images to VPS
      run: |
        scp -P ${{ secrets.SSH_PORT }} ./images/user-service.tar ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:/tmp/

    - name: Deploy Images on VPS
      run: |
        ssh -p ${{ secrets.SSH_PORT }} ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << EOF
        echo "üì¶ Loading image for user-service..."
        docker load -i /tmp/user-service.tar
        docker stop user-service || true
        docker rm user-service || true
        docker run -d --name user-service --restart=unless-stopped --expose 8085 --network logistik_nginx_proxy_manager_default user-service:latest  # Ganti port sesuai kebutuhan
        EOF
