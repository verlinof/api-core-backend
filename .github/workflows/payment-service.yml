name: CI Docker

on:
  push:
    tags:
      - payment-service

env:
  SERVICES: "payment-service"

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: dev

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Setup SSH
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.SSH_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        PORT=${{ secrets.SSH_PORT }}
        HOST=${{ secrets.SSH_HOST }}
        ssh-keyscan -p "${PORT:-22}" "$HOST" >> ~/.ssh/known_hosts

    - name: Build Docker Images and Save as TAR
      run: |
        mkdir -p images
        for SERVICE in $SERVICES; do
          touch ./services/$SERVICE/.env
          echo "DEBUG_MODE=${{ vars.DEBUG_MODE }}" >> ./services/$SERVICE/.env
          echo "ENVIRONMENT=${{ vars.ENVIRONMENT }}" >> ./services/$SERVICE/.env          
          echo "USE_REST=${{ vars.USE_REST }}" >> ./services/$SERVICE/.env          
          echo "LOAD_CONFIG_TIMEOUT=${{ vars.LOAD_CONFIG_TIMEOUT }}" >> ./services/$SERVICE/.env
          echo "BASIC_AUTH_PASS=${{ secrets.BASIC_AUTH_PASS }}" >> ./services/$SERVICE/.env
          echo "BASIC_AUTH_USERNAME=${{ secrets.BASIC_AUTH_USERNAME }}" >> ./services/$SERVICE/.env
          echo "REDIS_READ_DSN=${{ secrets.REDIS_READ_DSN }}" >> ./services/$SERVICE/.env
          echo "REDIS_WRITE_DSN=${{ secrets.REDIS_WRITE_DSN }}" >> ./services/$SERVICE/.env         
          echo "SQL_DB_READ_DSN=${{ secrets.SQL_DB_READ_DSN }}" >> ./services/$SERVICE/.env          
          echo "SQL_DB_WRITE_DSN=${{ secrets.SQL_DB_WRITE_DSN }}" >> ./services/$SERVICE/.env
          echo "HTTP_PORT=${{ vars.HTTP_PORT }}" >> ./services/$SERVICE/.env
          echo "MIDTRANS_ENV=${{ vars.MIDTRANS_ENV }}" >> ./services/$SERVICE/.env
          echo "MIDTRANS_MERCHANT_ID=${{ vars.MIDTRANS_MERCHANT_ID }}" >> ./services/$SERVICE/.env
          echo "MIDTRANS_SERVER_KEY=${{ secrets.MIDTRANS_SERVER_KEY }}" >> ./services/$SERVICE/.env
          echo "MIDTRANS_CLIENT_KEY=${{ vars.MIDTRANS_CLIENT_KEY }}" >> ./services/$SERVICE/.env

          IMAGE_NAME=$SERVICE:latest
          echo "üõ†Ô∏è Building $IMAGE_NAME"
            docker build -t $IMAGE_NAME ./services/$SERVICE
          docker save -o ./images/$SERVICE.tar $IMAGE_NAME
        done

    - name: Copy Images to VPS
      run: |
        for SERVICE in $SERVICES; do
          scp -P ${{ secrets.SSH_PORT }} ./images/$SERVICE.tar ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:/tmp/
        done

    - name: Deploy Images on VPS
      run: |
        ssh -p ${{ secrets.SSH_PORT }} ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << EOF
          set -e
          for SERVICE in $SERVICES; do
            echo "üì¶ Loading image for \$SERVICE..."
            docker load -i /tmp/\$SERVICE.tar
            docker stop \$SERVICE || true
            docker rm \$SERVICE || true
            docker run -d --name \$SERVICE --restart=unless-stopped --expose ${{ vars.HTTP_PORT }} --network logistik_nginx_proxy_manager_default \$SERVICE:latest  # Ganti port sesuai kebutuhan
          done
        EOF
